
-- Найти все компании поставщиков из тех стран, в которые делают заказы заказчики
SELECT s.company_name
FROM suppliers s
WHERE country IN (SELECT DISTINCT country FROM customers)
-- То же самое
SELECT DISTINCT s.company_name
FROM suppliers s
JOIN customers USING(country);


-- Кринж синтетический пример задачи
SELECT c.category_name, SUM(p.units_in_stock)
FROM products p
INNER JOIN categories c USING(category_id)
GROUP BY c.category_name
ORDER BY SUM(p.units_in_stock) DESC
LIMIT(
	SELECT MIN(product_id) + 4 FROM products
);


-- Товары, количество которых в наличии больше чем в среднем
SELECT p.product_name, p.units_in_stock
FROM products p
WHERE p.units_in_stock > (
	SELECT AVG(units_in_stock)
	FROM products
)
ORDER BY p.units_in_stock;



-------------------------------------------------------------------------- WHERE EXISTS

-- WHERE EXISTS возвращает true, когда в подзапросе была возвращена хотя бы одна строка

-- Компании и имена заказчиков, которые делали заказы весом от 50 до 100
SELECT c.company_name, c.contact_name
FROM customers c
WHERE EXISTS (
	SELECT customer_id
	FROM orders o
	WHERE customer_id = c.customer_id  -- customer_id совпадает
	AND o.freight BETWEEN 50 AND 100   -- заказ от 50 до 100
)
ORDER BY c.company_name, c.contact_name;
-- То же самое
SELECT DISTINCT c.company_name, c.contact_name
FROM customers c
INNER JOIN orders o USING(customer_id)
WHERE o.freight BETWEEN 50 AND 100
ORDER BY c.company_name, c.contact_name;


-- Можно использовать NOT EXISTS
-- Компании и имена заказчиков, которые не делали заказы в период '1995-02-01' - '1995-02-15'
SELECT c.company_name, c.contact_name
FROM customers c
WHERE NOT EXISTS (
	SELECT customer_id
	FROM orders o
	WHERE customer_id = c.customer_id  -- customer_id совпадает
	AND o.order_date BETWEEN '1995-02-01' AND '1995-02-15'
)
ORDER BY c.company_name, c.contact_name;


-- Выбрать продукты, которые не покупались в период '1995-02-01' - '1995-02-15'

SELECT p.product_name
FROM products p
WHERE NOT EXISTS (
	SELECT o.order_id
	FROM orders o
	INNER JOIN order_details od USING(order_id)
	WHERE od.product_id = p.product_id 						-- product_id из p из FROM
	AND o.order_date BETWEEN '1995-02-01' AND '1995-02-15'
);


-------------------------------------------------------------------------- квантификаторы ANY, ALL

-- Выбрать все уникальные компании заказчиков, которые делали заказы > чем на 40 единиц товаров

SELECT DISTINCT c.company_name
FROM customers c
JOIN orders o USING(customer_id)
JOIN order_details USING(order_id)
WHERE quantity > 40;
-- То же самое
SELECT DISTINCT c.company_name
FROM customers c
WHERE c.customer_id = ANY(
	SELECT customer_id
	FROM orders
	JOIN order_details USING(order_id)
	WHERE quantity > 40
);


-- Выбрать такие продукты, количество которых в заказах больше чем в среднем
SELECT DISTINCT p.product_name, od.quantity
FROM products p
JOIN order_details od USING(product_id)
WHERE quantity > (
	SELECT AVG(od.quantity)
	FROM order_details od 
)
ORDER BY quantity;



-- Найти все продукты, количество которых блольше всех средних значений количества заказанных товаров из групп, полученных группированием по product_id
SELECT DISTINCT p.product_name, od.quantity
FROM products p
JOIN order_details od USING(product_id)
WHERE quantity > ALL( -- то же самое было бы с MAX
	SELECT AVG(od.quantity)
	FROM order_details od
	GROUP BY od.product_id
)
ORDER BY od.quantity;





